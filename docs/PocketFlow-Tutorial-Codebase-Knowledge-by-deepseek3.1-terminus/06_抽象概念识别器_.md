# Chapter 6: æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨

æ¬¢è¿æ¥åˆ° PocketFlow æ•™ç¨‹ä»£ç åº“çŸ¥è¯†ç³»åˆ—çš„ç¬¬å…­ç« ï¼åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†[LLMè°ƒç”¨ç®¡ç†å™¨](05_llmè°ƒç”¨ç®¡ç†å™¨_.md)å¦‚ä½•ä½œä¸ºç³»ç»Ÿçš„"AIå¯¹è¯ä¸“å®¶"ï¼Œä¸å¤§å‹è¯­è¨€æ¨¡å‹è¿›è¡Œé«˜æ•ˆäº¤äº’ã€‚æœ¬ç« æˆ‘ä»¬å°†æ·±å…¥äº†è§£**æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨**ï¼Œå®ƒå°±åƒæ˜¯æ•´ä¸ªç³»ç»Ÿçš„"ä»£ç é˜…è¯»ä¸“å®¶"ï¼Œèƒ½å¤Ÿæ™ºèƒ½åˆ†æä»£ç åº“å¹¶è¯†åˆ«å‡ºæœ€é‡è¦çš„æ ¸å¿ƒæ¦‚å¿µã€‚

## ä¸ºä»€ä¹ˆéœ€è¦æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ä½ ç¬¬ä¸€æ¬¡èµ°è¿›ä¸€ä¸ªå·¨å¤§çš„å›¾ä¹¦é¦†ï¼Œé‡Œé¢æœ‰æˆåƒä¸Šä¸‡æœ¬ä¹¦ã€‚å¦‚æœä½ ä¸çŸ¥é“ä»å“ªé‡Œå¼€å§‹ï¼Œå¯èƒ½ä¼šæ„Ÿåˆ°ä¸çŸ¥æ‰€æªã€‚æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨å°±åƒæ˜¯ä½ çš„"å›¾ä¹¦ç®¡ç†å‘˜"ï¼Œå®ƒå¸®ä½ ï¼š

- ğŸ” **å‘ç°é‡ç‚¹**ï¼šä»æµ·é‡ä»£ç ä¸­æ‰¾å‡ºæœ€é‡è¦çš„æ ¸å¿ƒæ¦‚å¿µ
- ğŸ¯ **ç®€åŒ–ç†è§£**ï¼šä¸ºåˆå­¦è€…æä¾›æ¸…æ™°çš„æ¶æ„æ¦‚è§ˆ  
- ğŸ“š **ç»„ç»‡çŸ¥è¯†**ï¼šå°†å¤æ‚çš„ä»£ç ç»“æ„è½¬åŒ–ä¸ºæ˜“äºç†è§£çš„æ¦‚å¿µ
- ğŸŒ **å¤šè¯­è¨€æ”¯æŒ**ï¼šç”¨ä½ ç†Ÿæ‚‰çš„è¯­è¨€è§£é‡ŠæŠ€æœ¯æ¦‚å¿µ

## æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨çš„å·¥ä½œåŸç†

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ä¸»è¦çš„ä»£ç ä½äº `nodes.py` æ–‡ä»¶çš„ `IdentifyAbstractions` ç±»ä¸­ï¼š

```python
class IdentifyAbstractions(Node):
    def prep(self, shared):
        files_data = shared["files"]
        project_name = shared["project_name"]
        language = shared.get("language", "english")
        use_cache = shared.get("use_cache", True)
        max_abstraction_num = shared.get("max_abstraction_num", 10)
        
        # å‡†å¤‡LLMåˆ†ææ‰€éœ€çš„ä¸Šä¸‹æ–‡
        context, file_info = create_llm_context(files_data)
        return (context, file_listing, file_count, project_name, 
                language, use_cache, max_abstraction_num)
```

è¿™æ®µä»£ç å±•ç¤ºäº†æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨çš„å‡†å¤‡å·¥ä½œé˜¶æ®µã€‚å®ƒæ”¶é›†æ‰€æœ‰å¿…è¦çš„å‚æ•°ï¼Œä¸ºåç»­çš„æ™ºèƒ½åˆ†æåšå¥½å‡†å¤‡ã€‚

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. æ™ºèƒ½ä»£ç åˆ†æ

æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨ä½¿ç”¨LLMæŠ€æœ¯æ¥ç†è§£ä»£ç çš„ç»“æ„å’ŒåŠŸèƒ½ï¼š

```python
def exec(self, prep_res):
    # å‡†å¤‡ç»™LLMçš„æç¤ºè¯
    prompt = f"""
åˆ†æä»£ç åº“ä¸Šä¸‹æ–‡...
è¯†åˆ«5-{max_abstraction_num}ä¸ªæœ€é‡è¦çš„æ ¸å¿ƒæŠ½è±¡æ¦‚å¿µ...
ä¸ºæ¯ä¸ªæ¦‚å¿µæä¾›åç§°ã€æè¿°å’Œç›¸å…³æ–‡ä»¶ç´¢å¼•...
"""
    
    # è°ƒç”¨LLMè¿›è¡Œåˆ†æ
    response = call_llm(prompt, use_cache=True)
    
    # è§£æLLMçš„å“åº”
    yaml_str = response.strip().split("```yaml")[1].split("```")[0].strip()
    abstractions = yaml.safe_load(yaml_str)
```

è¿™å°±åƒæ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„ä»£ç å®¡æŸ¥ä¸“å®¶åœ¨ä»”ç»†é˜…è¯»ä½ çš„ä»£ç åº“ã€‚

### 2. å¤šè¯­è¨€æ¦‚å¿µè¯†åˆ«

æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨æ”¯æŒå¤šè¯­è¨€è¾“å‡ºï¼Œç¡®ä¿æ¦‚å¿µåç§°å’Œæè¿°ç¬¦åˆç”¨æˆ·çš„è¯­è¨€åå¥½ï¼š

```python
# å¦‚æœä¸æ˜¯è‹±è¯­ï¼Œæ·»åŠ è¯­è¨€æŒ‡ä»¤
if language.lower() != "english":
    language_instruction = f"ç”¨**{language.capitalize()}**ç”Ÿæˆæ¦‚å¿µåç§°å’Œæè¿°"
    name_lang_hint = f"ï¼ˆç”¨{language.capitalize()}ï¼‰"
    desc_lang_hint = f"ï¼ˆç”¨{language.capitalize()}ï¼‰"
```

è¿™æ ·ï¼Œä¸­æ–‡ç”¨æˆ·å°±èƒ½çœ‹åˆ°ç”¨ä¸­æ–‡æè¿°çš„æŠ€æœ¯æ¦‚å¿µï¼Œå¤§å¤§é™ä½äº†å­¦ä¹ é—¨æ§›ã€‚

### 3. éªŒè¯å’Œæ ‡å‡†åŒ–è¾“å‡º

è¯†åˆ«å™¨ä¼šä¸¥æ ¼éªŒè¯LLMçš„è¾“å‡ºæ ¼å¼ï¼Œç¡®ä¿æ•°æ®çš„å‡†ç¡®æ€§ï¼š

```python
# éªŒè¯æ¯ä¸ªæŠ½è±¡æ¦‚å¿µçš„æ ¼å¼
validated_abstractions = []
for item in abstractions:
    if not all(k in item for k in ["name", "description", "file_indices"]):
        raise ValueError(f"æ¦‚å¿µç¼ºå°‘å¿…è¦å­—æ®µ: {item}")
    
    # éªŒè¯æ–‡ä»¶ç´¢å¼•çš„æœ‰æ•ˆæ€§
    validated_indices = []
    for idx_entry in item["file_indices"]:
        idx = int(idx_entry.split("#")[0].strip())
        if not (0 <= idx < file_count):
            raise ValueError(f"æ— æ•ˆçš„æ–‡ä»¶ç´¢å¼•: {idx}")
```

è¿™ç§ä¸¥æ ¼çš„éªŒè¯ç¡®ä¿äº†ç”Ÿæˆçš„æ¦‚å¿µæ•°æ®æ˜¯å¯é å’Œå¯ç”¨çš„ã€‚

## å®é™…å·¥ä½œæµç¨‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªåºåˆ—å›¾æ¥çœ‹çœ‹æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨åœ¨å®Œæ•´æµç¨‹ä¸­çš„è§’è‰²ï¼š

```mermaid
sequenceDiagram
    participant ä»£ç åº“è·å–å™¨
    participant æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨
    participant LLMè°ƒç”¨ç®¡ç†å™¨
    participant å¤§å‹è¯­è¨€æ¨¡å‹
    
    ä»£ç åº“è·å–å™¨->>æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨: ä¼ é€’ä»£ç æ–‡ä»¶åˆ—è¡¨
    æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨->>æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨: å‡†å¤‡åˆ†æä¸Šä¸‹æ–‡
    æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨->>LLMè°ƒç”¨ç®¡ç†å™¨: å‘é€åˆ†æè¯·æ±‚
    LLMè°ƒç”¨ç®¡ç†å™¨->>å¤§å‹è¯­è¨€æ¨¡å‹: è°ƒç”¨AIåˆ†æä»£ç 
    å¤§å‹è¯­è¨€æ¨¡å‹-->>LLMè°ƒç”¨ç®¡ç†å™¨: è¿”å›æ¦‚å¿µåˆ†æç»“æœ
    LLMè°ƒç”¨ç®¡ç†å™¨-->>æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨: è¿”å›LLMå“åº”
    æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨->>æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨: éªŒè¯å’Œæ ‡å‡†åŒ–ç»“æœ
    æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨-->>åç»­èŠ‚ç‚¹: ä¼ é€’è¯†åˆ«çš„æ¦‚å¿µåˆ—è¡¨
```

## æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨çš„å†…éƒ¨å®ç°

### ä¸Šä¸‹æ–‡å‡†å¤‡é˜¶æ®µ

è¯†åˆ«å™¨é¦–å…ˆéœ€è¦ä¸ºLLMå‡†å¤‡åˆé€‚çš„åˆ†æä¸Šä¸‹æ–‡ï¼š

```python
def create_llm_context(files_data):
    context = ""
    file_info = []
    
    # ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºæ ¼å¼åŒ–çš„ä¸Šä¸‹æ–‡æ¡ç›®
    for i, (path, content) in enumerate(files_data):
        entry = f"--- æ–‡ä»¶ç´¢å¼• {i}: {path} ---\n{content}\n\n"
        context += entry
        file_info.append((i, path))
    
    return context, file_info
```

è¿™ç§æ–¹æ³•ç¡®ä¿äº†LLMèƒ½å¤Ÿè·å¾—å®Œæ•´çš„ä»£ç åº“è§†å›¾ï¼Œå°±åƒç»™ä¸“å®¶æä¾›äº†æ‰€æœ‰ç›¸å…³çš„æ–‡æ¡£ä¸€æ ·ã€‚

### æ™ºèƒ½æç¤ºè¯è®¾è®¡

è¯†åˆ«å™¨ä½¿ç”¨ç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯æ¥å¼•å¯¼LLMè¿›è¡Œæœ‰æ•ˆçš„æ¦‚å¿µè¯†åˆ«ï¼š

```python
prompt = f"""
ä¸ºé¡¹ç›® `{project_name}` åˆ†æä»£ç åº“ï¼š

ä»£ç åº“ä¸Šä¸‹æ–‡ï¼š
{context}

{language_instruction}åˆ†æä»£ç åº“ä¸Šä¸‹æ–‡ï¼Œè¯†åˆ«5-{max_abstraction_num}ä¸ªå¯¹ä»£ç åº“æ–°æ‰‹æœ€é‡è¦çš„æ ¸å¿ƒæŠ½è±¡æ¦‚å¿µã€‚

ä¸ºæ¯ä¸ªæŠ½è±¡æ¦‚å¿µæä¾›ï¼š
1. ç®€æ´çš„`åç§°`{name_lang_hint}
2. åˆå­¦è€…å‹å¥½çš„`æè¿°`ï¼Œç”¨ç®€å•çš„ç±»æ¯”è§£é‡Šå®ƒæ˜¯ä»€ä¹ˆ{desc_lang_hint}  
3. ç›¸å…³çš„`æ–‡ä»¶ç´¢å¼•`åˆ—è¡¨

æ ¼å¼åŒ–ä¸ºYAMLå­—å…¸åˆ—è¡¨ï¼š
```yaml
- name: |
    æŸ¥è¯¢å¤„ç†{name_lang_hint}
  description: |
    è§£é‡Šè¿™ä¸ªæŠ½è±¡æ¦‚å¿µçš„åŠŸèƒ½ã€‚
    å®ƒå°±åƒæ˜¯ä¸€ä¸ªä¸­å¤®è°ƒåº¦å™¨ï¼Œè´Ÿè´£è·¯ç”±è¯·æ±‚ã€‚{desc_lang_hint}
  file_indices:
    - 0 # è·¯å¾„/åˆ°/æ–‡ä»¶1.py
    - 3 # è·¯å¾„/åˆ°/ç›¸å…³æ–‡ä»¶.py
```
"""
```

è¿™ç§æç¤ºè¯è®¾è®¡ç¡®ä¿äº†LLMèƒ½å¤Ÿäº§ç”Ÿç»“æ„åŒ–ã€é«˜è´¨é‡çš„å“åº”ã€‚

### ç»“æœéªŒè¯å’Œå¤„ç†

è¯†åˆ«å™¨ä¼šä»”ç»†éªŒè¯LLMçš„è¾“å‡ºï¼Œå¹¶è½¬æ¢ä¸ºå†…éƒ¨æ ‡å‡†æ ¼å¼ï¼š

```python
# éªŒè¯æŠ½è±¡æ¦‚å¿µåˆ—è¡¨æ ¼å¼
if not isinstance(abstractions, list):
    raise ValueError("LLMè¾“å‡ºä¸æ˜¯åˆ—è¡¨æ ¼å¼")

# å¤„ç†æ¯ä¸ªæŠ½è±¡æ¦‚å¿µ
validated_abstractions = []
for item in abstractions:
    # æå–å’ŒéªŒè¯æ–‡ä»¶ç´¢å¼•
    validated_indices = []
    for idx_entry in item["file_indices"]:
        idx = int(idx_entry.split("#")[0].strip())
        validated_indices.append(idx)
    
    # åˆ›å»ºæ ‡å‡†åŒ–çš„æ¦‚å¿µå¯¹è±¡
    validated_abstractions.append({
        "name": item["name"],        # å¯èƒ½å·²ç¿»è¯‘çš„åç§°
        "description": item["description"],  # å¯èƒ½å·²ç¿»è¯‘çš„æè¿°
        "files": sorted(list(set(validated_indices)))  # å»é‡å¹¶æ’åºçš„æ–‡ä»¶ç´¢å¼•
    })
```

## å®é™…ä½¿ç”¨ç¤ºä¾‹

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„Webåº”ç”¨é¡¹ç›®ï¼ŒæŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨å¯èƒ½ä¼šè¯†åˆ«å‡ºä»¥ä¸‹æ¦‚å¿µï¼š

```yaml
- name: |
    è¯·æ±‚è·¯ç”±å™¨
  description: |
    è´Ÿè´£å°†HTTPè¯·æ±‚åˆ†å‘åˆ°ç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚
    å®ƒå°±åƒé¤å…çš„æ¥å¾…å‘˜ï¼Œæ ¹æ®å®¢äººçš„éœ€æ±‚å¼•å¯¼åˆ°åˆé€‚çš„åº§ä½ã€‚
  file_indices:
    - 0 # src/router.py
    - 1 # src/handlers/user_handler.py

- name: |
    æ•°æ®åº“è¿æ¥å™¨  
  description: |
    ç®¡ç†åº”ç”¨ä¸æ•°æ®åº“ä¹‹é—´çš„è¿æ¥å’Œé€šä¿¡ã€‚
    ç±»ä¼¼äºç”µè¯æ¥çº¿å‘˜ï¼Œç¡®ä¿é€šè¯çº¿è·¯ç•…é€šã€‚
  file_indices:
    - 2 # src/database.py
    - 3 # src/models/user.py
```

è¿™äº›æ¦‚å¿µä¸ºåç»­çš„æ•™ç¨‹ç”Ÿæˆæä¾›äº†åšå®çš„åŸºç¡€ã€‚

## é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨å†…ç½®äº†å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š

```python
try:
    response = call_llm(prompt, use_cache=True)
    # å¤„ç†å“åº”...
except Exception as e:
    print(f"è¯†åˆ«æŠ½è±¡æ¦‚å¿µæ—¶å‡ºé”™: {e}")
    if self.cur_retry < self.max_retries:
        print(f"ç¬¬{self.cur_retry+1}æ¬¡é‡è¯•...")
        time.sleep(self.wait)
        self.cur_retry += 1
        return self.exec(prep_res)  # é‡è¯•
    else:
        raise e  # é‡è¯•æ¬¡æ•°ç”¨å°½
```

è¿™ç§æœºåˆ¶ç¡®ä¿äº†å³ä½¿åœ¨ç½‘ç»œä¸ç¨³å®šæˆ–LLMæœåŠ¡å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼Œè¯†åˆ«è¿‡ç¨‹ä¹Ÿèƒ½é¡ºåˆ©å®Œæˆã€‚

## å¤šè¯­è¨€æ”¯æŒçš„å®é™…æ•ˆæœ

å¯¹äºä¸­æ–‡ç”¨æˆ·ï¼ŒæŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨ä¼šç”Ÿæˆä¸­æ–‡çš„æ¦‚å¿µæè¿°ï¼š

```python
# ä¸­æ–‡è¾“å‡ºçš„ç¤ºä¾‹
æŠ½è±¡æ¦‚å¿µåˆ—è¡¨ = [
    {
        "name": "é…ç½®ç®¡ç†å™¨",
        "description": "è´Ÿè´£è¯»å–å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„é…ç½®è®¾ç½®ã€‚å°±åƒæ±½è½¦çš„ä»ªè¡¨ç›˜ï¼Œå¯ä»¥è°ƒæ•´å„ç§å‚æ•°æ¥ä¼˜åŒ–æ€§èƒ½ã€‚", 
        "files": [4, 5]
    },
    {
        "name": "æ—¥å¿—è®°å½•å™¨",
        "description": "è®°å½•åº”ç”¨ç¨‹åºçš„è¿è¡ŒçŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯ã€‚ç±»ä¼¼äºé£æœºçš„é»‘åŒ£å­ï¼Œå¸®åŠ©å¼€å‘è€…è¯Šæ–­é—®é¢˜ã€‚",
        "files": [6, 7]
    }
]
```

è¿™ç§æœ¬åœ°åŒ–çš„æè¿°å¤§å¤§æé«˜äº†æ•™ç¨‹çš„å¯è¯»æ€§å’Œå®ç”¨æ€§ã€‚

## æ€»ç»“

é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬äº†è§£äº†æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨çš„æ ¸å¿ƒä½œç”¨ï¼š

- ğŸ” **æ™ºèƒ½ä»£ç é˜…è¯»å™¨**ï¼šä½¿ç”¨LLMæŠ€æœ¯æ·±åº¦åˆ†æä»£ç ç»“æ„å’ŒåŠŸèƒ½
- ğŸ¯ **æ¦‚å¿µæå–ä¸“å®¶**ï¼šä»å¤æ‚ä»£ç ä¸­è¯†åˆ«å‡ºæœ€é‡è¦çš„æ ¸å¿ƒæ¦‚å¿µ  
- ğŸŒ **å¤šè¯­è¨€æ”¯æŒè€…**ï¼šç”¨ç”¨æˆ·ç†Ÿæ‚‰çš„è¯­è¨€æè¿°æŠ€æœ¯æ¦‚å¿µ
- âœ… **è´¨é‡ä¿è¯å‘˜**ï¼šä¸¥æ ¼éªŒè¯è¾“å‡ºæ ¼å¼ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®æ€§
- ğŸ”„ **å®¹é”™å¤„ç†å™¨**ï¼šå†…ç½®é‡è¯•æœºåˆ¶ï¼Œä¿è¯è¯†åˆ«è¿‡ç¨‹çš„ç¨³å®šæ€§

æŠ½è±¡æ¦‚å¿µè¯†åˆ«å™¨å°±åƒæ˜¯æ•™ç¨‹ç”Ÿæˆç³»ç»Ÿçš„"æ¶æ„åˆ†æå¸ˆ"ï¼Œå®ƒä¸ºåç»­çš„æ•™ç¨‹å†…å®¹æä¾›äº†æ¸…æ™°çš„æ¦‚å¿µæ¡†æ¶ï¼Œè®©åˆå­¦è€…èƒ½å¤Ÿå¿«é€Ÿç†è§£ä»£ç åº“çš„æ ¸å¿ƒæ€æƒ³ã€‚

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢[å…³ç³»åˆ†æå™¨](07_å…³ç³»åˆ†æå™¨_.md)ï¼Œå­¦ä¹ ç³»ç»Ÿå¦‚ä½•åˆ†æå„ä¸ªæŠ½è±¡æ¦‚å¿µä¹‹é—´çš„ç›¸äº’ä½œç”¨å’Œä¾èµ–å…³ç³»ã€‚è®©æˆ‘ä»¬ç»§ç»­è¿™ä¸ªç²¾å½©çš„å­¦ä¹ ä¹‹æ—…ï¼

---
Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)