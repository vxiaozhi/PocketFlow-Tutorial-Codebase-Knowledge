# Chapter 3: ä»£ç åº“è·å–å™¨

æ¬¢è¿æ¥åˆ° PocketFlow æ•™ç¨‹ä»£ç åº“çŸ¥è¯†ç³»åˆ—çš„ç¬¬ä¸‰ç« ï¼åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†[é…ç½®å‚æ•°å¤„ç†å™¨](02_é…ç½®å‚æ•°å¤„ç†å™¨_.md)å¦‚ä½•æ”¶é›†å’ŒéªŒè¯ç”Ÿæˆæ•™ç¨‹æ‰€éœ€çš„å„ç§é…ç½®å‚æ•°ã€‚æœ¬ç« æˆ‘ä»¬å°†æ·±å…¥äº†è§£**ä»£ç åº“è·å–å™¨**ï¼Œå®ƒå°±åƒæ˜¯æ•´ä¸ªç³»ç»Ÿçš„"æ•°æ®æ”¶é›†å‘˜"ï¼Œè´Ÿè´£ä»GitHubä»“åº“æˆ–æœ¬åœ°ç›®å½•è·å–æºä»£ç æ–‡ä»¶ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦ä»£ç åº“è·å–å™¨ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ä½ è¦ä¸ºæœ‹å‹å‡†å¤‡ä¸€ä»½ç”Ÿæ—¥ç¤¼ç‰©ï¼Œä½†ä½ éœ€è¦å…ˆçŸ¥é“ä»–ä»¬å–œæ¬¢ä»€ä¹ˆã€‚ä»£ç åº“è·å–å™¨å°±åƒæ˜¯ä½ çš„"ç¤¼ç‰©ä¾¦å¯Ÿå‘˜"ï¼Œå®ƒå¸®ä½ ï¼š

- ğŸ“‚ **æ”¶é›†ææ–™**ï¼šä»GitHubä»“åº“æˆ–æœ¬åœ°ç›®å½•è·å–æºä»£ç æ–‡ä»¶
- ğŸ¯ **æ™ºèƒ½ç­›é€‰**ï¼šæ ¹æ®æ–‡ä»¶ç±»å‹å’Œå¤§å°è¿‡æ»¤æ–‡ä»¶
- ğŸ—‚ï¸ **æ•´ç†å½’ç±»**ï¼šä¸ºåç»­å¤„ç†æä¾›æ ‡å‡†åŒ–çš„æ–‡ä»¶ç»“æ„
- ğŸ” **å¤„ç†æƒé™**ï¼šç®¡ç†GitHubè®¤è¯å’Œè®¿é—®æƒé™

## ä»£ç åº“è·å–å™¨çš„å·¥ä½œåŸç†

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£ä»£ç åº“è·å–å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ä¸»è¦çš„ä»£ç ä½äº `nodes.py` æ–‡ä»¶çš„ `FetchRepo` ç±»ä¸­ï¼š

```python
class FetchRepo(Node):
    def prep(self, shared):
        # ä»å…±äº«é…ç½®ä¸­è·å–å‚æ•°
        repo_url = shared.get("repo_url")
        local_dir = shared.get("local_dir")
        include_patterns = shared["include_patterns"]
        exclude_patterns = shared["exclude_patterns"]
        max_file_size = shared["max_file_size"]
        
        return {
            "repo_url": repo_url,
            "local_dir": local_dir,
            "token": shared.get("github_token"),
            "include_patterns": include_patterns,
            "exclude_patterns": exclude_patterns,
            "max_file_size": max_file_size,
            "use_relative_paths": True,
        }
```

è¿™æ®µä»£ç å±•ç¤ºäº†ä»£ç åº“è·å–å™¨çš„å‡†å¤‡å·¥ä½œé˜¶æ®µã€‚å®ƒä»å…±äº«é…ç½®å­—å…¸ä¸­è·å–æ‰€æœ‰å¿…è¦çš„å‚æ•°ï¼Œå°±åƒä¾¦å¯Ÿå‘˜æ”¶é›†ä»»åŠ¡æŒ‡ä»¤ä¸€æ ·ã€‚

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. æ™ºèƒ½æ–‡ä»¶ç­›é€‰

ä»£ç åº“è·å–å™¨èƒ½å¤Ÿæ ¹æ®æ–‡ä»¶æ¨¡å¼æ™ºèƒ½ç­›é€‰æ–‡ä»¶ï¼š

```python
# é»˜è®¤åŒ…å«çš„æ–‡ä»¶ç±»å‹ï¼ˆå¦‚Pythonã€JavaScriptã€Markdownç­‰ï¼‰
DEFAULT_INCLUDE_PATTERNS = {
    "*.py", "*.js", "*.jsx", "*.ts", "*.tsx", "*.go", "*.java",
    "*.md", "*.rst", "*Dockerfile", "*Makefile", "*.yaml", "*.yml"
}

# é»˜è®¤æ’é™¤çš„æ–‡ä»¶ç±»å‹ï¼ˆå¦‚æµ‹è¯•æ–‡ä»¶ã€æ„å»ºç›®å½•ç­‰ï¼‰
DEFAULT_EXCLUDE_PATTERNS = {
    "*test*", "*tests/*", "*examples/*", "*dist/*", "*build/*",
    "*node_modules/*", ".git/*", ".github/*"
}
```

è¿™ç¡®ä¿äº†åªè·å–ä¸æ•™ç¨‹ç›¸å…³çš„æºä»£ç æ–‡ä»¶ï¼Œé¿å…å¤„ç†ä¸å¿…è¦çš„æ–‡ä»¶ã€‚

### 2. æ–‡ä»¶å¤§å°æ§åˆ¶

ä¸ºäº†é˜²æ­¢å¤„ç†è¿‡å¤§çš„æ–‡ä»¶ï¼Œä»£ç åº“è·å–å™¨ä¼šæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼š

```python
def exec(self, prep_res):
    if prep_res["repo_url"]:
        result = crawl_github_files(
            repo_url=prep_res["repo_url"],
            token=prep_res["token"],
            include_patterns=prep_res["include_patterns"],
            exclude_patterns=prep_res["exclude_patterns"],
            max_file_size=prep_res["max_file_size"],  # æ§åˆ¶æ–‡ä»¶å¤§å°
            use_relative_paths=prep_res["use_relative_paths"],
        )
```

### 3. ç›¸å¯¹è·¯å¾„æ˜ å°„

ä»£ç åº“è·å–å™¨æ”¯æŒç›¸å¯¹è·¯å¾„æ˜ å°„ï¼Œä¸ºåç»­å¤„ç†æä¾›æ ‡å‡†åŒ–çš„æ–‡ä»¶ç»“æ„ï¼š

```python
# å¯ç”¨ç›¸å¯¹è·¯å¾„æ˜ å°„
use_relative_paths=True

# ç¤ºä¾‹ï¼šå°†å®Œæ•´è·¯å¾„è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
# åŸå§‹è·¯å¾„ï¼š/home/user/project/src/main.py
# ç›¸å¯¹è·¯å¾„ï¼šsrc/main.py
```

## å®é™…å·¥ä½œæµç¨‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªåºåˆ—å›¾æ¥çœ‹çœ‹ä»£ç åº“è·å–å™¨åœ¨å®Œæ•´æµç¨‹ä¸­çš„è§’è‰²ï¼š

```mermaid
sequenceDiagram
    participant ç”¨æˆ·
    participant é…ç½®å‚æ•°å¤„ç†å™¨
    participant ä»£ç åº“è·å–å™¨
    participant GitHub API
    participant æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
    
    ç”¨æˆ·->>é…ç½®å‚æ•°å¤„ç†å™¨: æä¾›ä»“åº“URLæˆ–æœ¬åœ°è·¯å¾„
    é…ç½®å‚æ•°å¤„ç†å™¨->>ä»£ç åº“è·å–å™¨: ä¼ é€’é…ç½®å‚æ•°
    ä»£ç åº“è·å–å™¨->>GitHub API: è¯·æ±‚æºä»£ç æ–‡ä»¶ï¼ˆå¦‚ä½¿ç”¨GitHubï¼‰
    GitHub API-->>ä»£ç åº“è·å–å™¨: è¿”å›æ–‡ä»¶åˆ—è¡¨å’Œå†…å®¹
    ä»£ç åº“è·å–å™¨->>æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ: æ‰«ææœ¬åœ°ç›®å½•ï¼ˆå¦‚ä½¿ç”¨æœ¬åœ°è·¯å¾„ï¼‰
    æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ-->>ä»£ç åº“è·å–å™¨: è¿”å›æ–‡ä»¶åˆ—è¡¨å’Œå†…å®¹
    ä»£ç åº“è·å–å™¨->>ä»£ç åº“è·å–å™¨: è¿‡æ»¤æ–‡ä»¶ã€æ£€æŸ¥å¤§å°
    ä»£ç åº“è·å–å™¨-->>åç»­èŠ‚ç‚¹: ä¼ é€’æ ‡å‡†åŒ–çš„æ–‡ä»¶åˆ—è¡¨
```

## ä»£ç åº“è·å–å™¨çš„å†…éƒ¨å®ç°

### GitHubä»“åº“è·å–

å½“å¤„ç†GitHubä»“åº“æ—¶ï¼Œä»£ç åº“è·å–å™¨ä½¿ç”¨ `crawl_github_files` å‡½æ•°ï¼š

```python
def crawl_github_files(repo_url, token=None, max_file_size=1024*1024, 
                      use_relative_paths=False, include_patterns=None, 
                      exclude_patterns=None):
    """
    ä»GitHubä»“åº“è·å–æ–‡ä»¶
    
    Args:
        repo_url: GitHubä»“åº“URL
        token: GitHubè®¿é—®ä»¤ç‰Œï¼ˆç”¨äºç§æœ‰ä»“åº“ï¼‰
        max_file_size: æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
        use_relative_paths: æ˜¯å¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„
        include_patterns: åŒ…å«çš„æ–‡ä»¶æ¨¡å¼
        exclude_patterns: æ’é™¤çš„æ–‡ä»¶æ¨¡å¼
    """
```

è¿™ä¸ªå‡½æ•°ä¼šï¼š
1. è§£æGitHub URLï¼Œæå–ä»“åº“æ‰€æœ‰è€…ã€ä»“åº“åç­‰ä¿¡æ¯
2. ä½¿ç”¨GitHub APIè·å–æ–‡ä»¶åˆ—è¡¨
3. æ ¹æ®é…ç½®è¿‡æ»¤æ–‡ä»¶
4. ä¸‹è½½æ–‡ä»¶å†…å®¹å¹¶è¿”å›

### æœ¬åœ°ç›®å½•è·å–

å½“å¤„ç†æœ¬åœ°ç›®å½•æ—¶ï¼Œä»£ç åº“è·å–å™¨ä½¿ç”¨ `crawl_local_files` å‡½æ•°ï¼š

```python
def crawl_local_files(directory, include_patterns=None, 
                     exclude_patterns=None, max_file_size=None,
                     use_relative_paths=True):
    """
    ä»æœ¬åœ°ç›®å½•è·å–æ–‡ä»¶
    
    Args:
        directory: æœ¬åœ°ç›®å½•è·¯å¾„
        include_patterns: åŒ…å«çš„æ–‡ä»¶æ¨¡å¼
        exclude_patterns: æ’é™¤çš„æ–‡ä»¶æ¨¡å¼
        max_file_size: æœ€å¤§æ–‡ä»¶å¤§å°
        use_relative_paths: æ˜¯å¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„
    """
```

è¿™ä¸ªå‡½æ•°ä¼šï¼š
1. æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
2. é€’å½’æ‰«æç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
3. æ ¹æ®.gitignoreæ–‡ä»¶å’Œé…ç½®æ¨¡å¼è¿‡æ»¤æ–‡ä»¶
4. è¯»å–æ–‡ä»¶å†…å®¹å¹¶è¿”å›

## å®é™…ä½¿ç”¨ç¤ºä¾‹

å‡è®¾æˆ‘ä»¬è¦è·å–ä¸€ä¸ªPythoné¡¹ç›®çš„æºä»£ç æ–‡ä»¶ï¼š

```python
# ä»GitHubä»“åº“è·å–æ–‡ä»¶
result = crawl_github_files(
    repo_url="https://github.com/example/project.git",
    include_patterns={"*.py", "*.md"},  # åªè·å–Pythonå’ŒMarkdownæ–‡ä»¶
    exclude_patterns={"tests/*", "docs/*"},  # æ’é™¤æµ‹è¯•å’Œæ–‡æ¡£ç›®å½•
    max_file_size=100000,  # æœ€å¤§æ–‡ä»¶å¤§å°100KB
    use_relative_paths=True  # ä½¿ç”¨ç›¸å¯¹è·¯å¾„
)

# å¤„ç†ç»“æœ
files_list = list(result.get("files", {}).items())
print(f"æˆåŠŸè·å– {len(files_list)} ä¸ªæ–‡ä»¶")
```

## é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

ä»£ç åº“è·å–å™¨å†…ç½®äº†é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```python
try:
    if prep_res["repo_url"]:
        result = crawl_github_files(...)
    else:
        result = crawl_local_files(...)
        
    files_list = list(result.get("files", {}).items())
    if len(files_list) == 0:
        raise ValueError("æœªèƒ½è·å–åˆ°æ–‡ä»¶")
        
except Exception as e:
    print(f"è·å–æ–‡ä»¶æ—¶å‡ºé”™: {e}")
    # è¿™é‡Œä¼šè§¦å‘èŠ‚ç‚¹çš„é‡è¯•æœºåˆ¶
```

## æ€»ç»“

é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬äº†è§£äº†ä»£ç åº“è·å–å™¨çš„æ ¸å¿ƒä½œç”¨ï¼š

- ğŸ¯ **æ™ºèƒ½æ–‡ä»¶æ”¶é›†å™¨**ï¼šä»GitHubæˆ–æœ¬åœ°ç›®å½•è·å–æºä»£ç æ–‡ä»¶
- ğŸ” **ç²¾ç¡®è¿‡æ»¤å™¨**ï¼šæ ¹æ®æ–‡ä»¶ç±»å‹ã€å¤§å°å’Œæ¨¡å¼æ™ºèƒ½ç­›é€‰æ–‡ä»¶
- ğŸ“ **æ ‡å‡†åŒ–ç»„ç»‡è€…**ï¼šæä¾›ç»Ÿä¸€çš„æ–‡ä»¶ç»“æ„ä¾›åç»­å¤„ç†ä½¿ç”¨
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†ä¸“å®¶**ï¼šå†…ç½®é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†

ä»£ç åº“è·å–å™¨å°±åƒæ˜¯æ•™ç¨‹ç”Ÿæˆç³»ç»Ÿçš„"ææ–™é‡‡è´­å‘˜"ï¼Œå®ƒç¡®ä¿åç»­æ‰€æœ‰å¤„ç†èŠ‚ç‚¹éƒ½èƒ½è·å¾—é«˜è´¨é‡ã€æ ‡å‡†åŒ–çš„æºä»£ç æ–‡ä»¶ï¼Œä¸ºç”Ÿæˆé«˜è´¨é‡çš„æ•™ç¨‹æ–‡æ¡£å¥ å®šäº†æ•°æ®åŸºç¡€ã€‚

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢[èŠ‚ç‚¹å¤„ç†å•å…ƒ](04_èŠ‚ç‚¹å¤„ç†å•å…ƒ_.md)ï¼Œå­¦ä¹ ç³»ç»Ÿå¦‚ä½•å¤„ç†å’Œåˆ†æè·å–åˆ°çš„æºä»£ç æ–‡ä»¶ã€‚è®©æˆ‘ä»¬ç»§ç»­è¿™ä¸ªç²¾å½©çš„å­¦ä¹ ä¹‹æ—…ï¼

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)